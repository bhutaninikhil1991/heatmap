<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <link href="style.css" rel="stylesheet">
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>

<h2>Yearly Region-Wise Air Passenger Heatmap</h2>

<svg></svg>

<p>Nikhil Bhutani</p>
<p>Source: https://data.sfgov.org/Transportation/Air-Traffic-Passenger-Statistics/rkru-6vcg/data</p>

<script>

// location of data file
let csv = 'Air_Traffic_Passenger_Statistics.csv';

// configuration of svg/plot area
let config = {
  'svg': {},
  'margin': {},
  'plot': {}
};

config.svg.height = 500;
config.svg.width = 960; // golden ratio

config.margin.top = 10;
config.margin.right = 10;
config.margin.bottom = 20;
config.margin.left = 100;

config.plot.x = config.margin.left;
config.plot.y = config.margin.top;
config.plot.width = config.svg.width - config.margin.left - config.margin.right;
config.plot.height = config.svg.height - config.margin.top - config.margin.bottom;

// setup svg
let svg = d3.select('body').select('svg');
svg.attr('width', config.svg.width);
svg.attr('height', config.svg.height);

// setup plot area
let plot = svg.append('g');
plot.attr('id', 'plot');
plot.attr('transform', translate(config.plot.x, config.plot.y));

// use a rect to illustrate plot area
let rect = plot.append('rect');
rect.attr('id', 'background');

rect.attr('x', 0);
rect.attr('y', 0);
rect.attr('width', config.plot.width);
rect.attr('height', config.plot.height);

// scales for data
// https://github.com/d3/d3-scale-chromatic
let scale = {};
scale.x = d3.scaleBand();
scale.x.range([0, config.plot.width]);
scale.y = d3.scaleBand();
scale.y.range([config.plot.height, 0]);

scale.color = d3.scaleSequential(d3.interpolateViridis);

// TODO

// axes for data
let axis = {};
axis.x = d3.axisBottom(scale.x);
axis.y = d3.axisLeft(scale.y);

axis.x.tickFormat(dateFormatter);
axis.y.tickFormat(regionFormatter);
// TODO

// load data
d3.csv(csv, convertRow).then(drawHeatmap);
// try: parseColumnName('201103');
let parseColumnName = d3.timeParse('%Y%m');

function convertRow(row, index) {
let out = {};
for(let col in row){
  switch (col) {
    case 'RegionName':
      out[col] = row[col];
      break;

    case 'Passenger_Count':
      out[col] = parseInt(row[col]);
      break;

    case 'Activity_Period':
        out[col] = parseColumnName(row[col]);
        break;

    default:
      break;
  }
}
  return out; // TODO
}


function drawHeatmap(data) {
  console.log(data);
  console.log(data[0]);

//grouping and sorting of data
  let dataGroup = d3.nest()
    .key(function(d) { return d.RegionName; })
    .sortKeys(d3.descending)
    .key(function(d) { return d.Activity_Period; })
    .rollup(function(v) { return d3.sum(v, function(d) { return d.Passenger_Count; }); })
    .entries(data)
    .map(function(group){
      return{
        "RegionName" : group.key,
        "values": group.values.map(function(subgroup){
          return{
            "date" : new Date(subgroup.key),
            "value" : subgroup.value
          }
        }).sort(function(a,b){
          return new Date(a.date)-new Date(b.date);
        })
      }
    });

    data = dataGroup;

  console.log(data);

  let regions = data.map(row => row['RegionName']);
  console.log(regions);

  let dates = data[0].values.map(value => value.date);
  console.log(dates);

  scale.x.domain(dates);
  scale.y.domain(regions);

  // draw the x and y axis
  let gx = svg.append("g");
  gx.attr("id", "x-axis");
  gx.attr("class", "axis");
  gx.attr("transform", translate(config.plot.x, config.plot.y + config.plot.height));
  gx.call(axis.x);

  let gy = svg.append("g");
  gy.attr("id", "y-axis");
  gy.attr("class", "axis");
  gy.attr("transform", translate(config.plot.x, config.plot.y));
  gy.call(axis.y);

  let values = data.map(d => d.values);
  let merged = d3.merge(values);
  let mapped = merged.map(d => d.value);

  let min = d3.min(mapped);
  let max = d3.max(mapped);
  let mid = d3.mean(mapped);

  scale.color.domain([min, mid, max]);

  let rows = plot.selectAll("g.cell")
            .data(data)
            .enter()
            .append("g");

    rows.attr("class", "cell");
    rows.attr("id", d => "Region-" + d.RegionName);

    // shift the entire group to the appropriate y-location
  rows.attr("transform", function(d) {
    return translate(0, scale.y(d["RegionName"]));
  });

  // create one rect per cell within row group
  let cells = rows.selectAll("rect")
    .data(d => d.values)
    .enter()
    .append("rect");

  cells.attr("x", d => scale.x(d.date));
  cells.attr("y", 0); // handled by group transform
  cells.attr("width", scale.x.bandwidth());
  cells.attr("height", scale.y.bandwidth());

  // here is the color magic!
  cells.style("fill", d => scale.color(d.value));
  cells.style("stroke", d => scale.color(d.value));
}

function dateFormatter(d) {
  if (d.getMonth() === 6) {
    return d.getFullYear().toString();
  }
}

function regionFormatter(d) {
  let text = d;
  let parts = text.split(/[,-]+/);

  if (parts !== null) {
    text = parts[0];

    if (parts.length > 2) {
      text = text + "+";
    }
  }

  return text;
}

function translate(x, y) {
  return 'translate(' + x + ',' + y + ')';
}

</script>
</body>
</html>
